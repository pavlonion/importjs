<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<style>
		#timer_widget {
			color: #FFFFFF;
			background-color: #0D5353;
			display: inline-block;
			padding: 20px;
		}
	</style>
</head>
<body>

	<div id="timer_widget">
		Timer: <span id="timer">0</span>
	</div>

	<script>
	(function main() {
		if (typeof window.CustomEvent != "function") {
			window.CustomEvent = function(event, params) {
				var default_params = { bubbles: false, cancelable: false, detail: undefined };

				for (var key in default_params) {
					if (typeof params[key] == "undefined") {
						params[key] = default_params[key];
					}
				}

				console.log(params);
				var evt = document.createEvent("CustomEvent");
				evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
				return evt;
			}

			window.CustomEvent.prototype = Object.create(window.Event.prototype);
		}

		var link = document.querySelector("link[rel=import][href$=\"timer.html\"]");
		if (!link) {
			console.warn("I'm a widget!");
			return;
		}
		
		var native_import_support = "import" in link;

		function startup() {
			var widget = link.import.querySelector("body > div");
			var timer = link.import.querySelector("#timer");
			var interval = setInterval(function() { timer.innerHTML++; }, 1000);

			document.dispatchEvent(new CustomEvent("timer_widget_ready", {
				detail: {
					widget: widget,
					interval: interval
				}
			}));
		}

		link.addEventListener("load", startup);
	})();
	</script>
</body>
</html>
